# Session Retrospective: Oracle v2 Drizzle Migration & Arthur UI

**Date**: 2026-01-03 20:30 GMT+7
**Duration**: ~1.5 hours
**Project**: oracle-v2

---

## AI Diary

A session of infrastructure and polish. Started with continuing from a previous context about project context features, then the user asked about database migration.

The Drizzle setup was surprisingly smooth. `drizzle-kit pull` introspected the existing SQLite database and generated a schema automatically. The tricky part was cleaning up FTS5 internal tables from the generated schema - Drizzle doesn't know these are SQLite's internal virtual table implementation, not user tables.

The user then spotted the "RAG: Offline" status in Arthur UI. Traced it to a port mismatch - Arthur was hardcoded to localhost:3456 but Oracle runs on 37778. Quick fixes: update the API_URL and add `oracleV2: 'connected'` to the health endpoint response.

Then came UI refinement. The user saw overlap between the "ORACLE KNOWLEDGE" button and the animated rings. Rebuilt the header as a proper flexbox bar, moved the title to center above the conversation. Several iterations of CSS tweaks. The final screenshot shows a clean, professional layout with all status indicators green.

The GraphQL discussion was interesting - Drizzle offers drizzle-graphql for auto-generated APIs. But after analyzing the use case, we decided against it. Oracle's core value is FTS5+ChromaDB search, which GraphQL can't help with. Stored the decision in Oracle's memory for future reference.

---

## What Was Accomplished

### 1. Project Context Feature
- `/context` endpoint for ghq-format path detection
- `project` column added to all logging tables
- Commit `1e36491`

### 2. Drizzle ORM Setup
- Installed drizzle-orm + drizzle-kit
- `drizzle-kit pull` introspected existing oracle.db
- Clean schema with 6 tables (excluding FTS5 internals)
- Added db:* npm scripts
- All 45 tests still pass
- Commit `64708c1`

### 3. Arthur UI Fixes
- Fixed API_URL: 3456 → 37778
- Added `oracleV2: 'connected'` to health endpoint
- Memory: Online, RAG: Active (5.5K)

### 4. Arthur UI Redesign
- New header bar with flexbox layout
- Title centered above conversation
- Status indicators with colored dots
- No more overlap issues

### 5. GraphQL Decision
- Evaluated drizzle-graphql
- Decided against: core search is FTS5+ChromaDB
- Stored decision in Oracle memory

---

## Technical Decisions

| Decision | Rationale |
|----------|-----------|
| Drizzle pull over manual schema | Auto-introspect existing DB, less error-prone |
| Exclude FTS5 tables from schema | Drizzle doesn't support virtual tables |
| Skip GraphQL | Search is custom logic, MCP is primary interface |
| Flexbox header bar | Clean separation, no overlap |

---

## Lessons Learned

1. **drizzle-kit pull** is powerful for existing databases
2. **FTS5 internal tables** need manual exclusion from Drizzle schema
3. **Health endpoint flags** can signal feature availability to UIs
4. **Don't add tech for the sake of it** - GraphQL adds complexity without solving real problems here

---

## Honest Feedback

### What Worked
- Drizzle introspection was fast and accurate
- Quick diagnosis of Arthur's connection issues
- UI iteration with dev-browser screenshots
- Storing decisions in Oracle for future reference

### What Could Be Better
- Arthur UI CSS could use more systematic organization
- Should have tested Arthur connection earlier in the session
- GraphQL evaluation could have been shorter

### Surprises
- Drizzle picked up all 12 tables including FTS5 internals
- Arthur was pointing to a completely different port
- The UI overlap was simpler to fix than expected

---

## Files Changed

```
oracle-v2/
├── src/server/context.ts      (+85) NEW - Project context detection
├── src/server/types.ts        (+15) ProjectContext interface
├── src/server.ts              (+10) /context endpoint, health flag
├── src/server/db.ts           (+15) Project column migration
├── src/server/logging.ts      (+20) Project param in log functions
├── src/db/schema.ts           (+95) NEW - Drizzle schema
├── src/db/index.ts            (+40) NEW - Drizzle client
├── drizzle.config.ts          (+24) NEW - Drizzle configuration
├── docs/API.md                (+35) /context documentation
├── package.json               (+7) db:* scripts, drizzle deps

Nat-s-Agents/ψ/lab/oracle-jarvis/
├── index.html                 (~100 lines changed) UI redesign
```

---

## Commits

| Hash | Description |
|------|-------------|
| d664e42 | chore: clean up ralph loop state |
| 64708c1 | feat: Add Drizzle ORM setup with introspected schema |
| 1e36491 | feat: Add project context awareness (ghq format) |

---

## Running Services

| Service | URL |
|---------|-----|
| Oracle HTTP | http://localhost:37778 |
| React Dashboard | http://localhost:3001 |
| Drizzle Studio | https://local.drizzle.studio |
| Arthur UI | http://localhost:37778/ |

---

## Tags

`drizzle` `migration` `arthur-ui` `graphql-decision` `project-context` `css`
