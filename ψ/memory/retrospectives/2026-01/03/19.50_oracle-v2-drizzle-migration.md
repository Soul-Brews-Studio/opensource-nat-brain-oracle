# Session Retrospective: Oracle v2 Drizzle Migration

**Date**: 2026-01-03 19:50 GMT+7
**Duration**: ~45 minutes
**Project**: oracle-v2

---

## AI Diary

Continued from the previous epic session. User wanted to implement the Drizzle migration that was planned in Issue #9.

Started by installing drizzle-orm and drizzle-kit. The `drizzle-kit pull` command is elegant - it introspected the existing oracle.db and generated a complete TypeScript schema. 12 tables, 60 columns, 11 indexes detected automatically.

The generated schema included FTS5 internal tables (oracle_fts_data, oracle_fts_idx, etc.) which shouldn't be managed by Drizzle. Cleaned those out and created a focused 6-table schema. The TypeScript compiler caught the usual `Database` type export issue - same fix as before with explicit `DatabaseType` import.

All 45 tests passed without modification - that was the goal. Drizzle is now an additional layer, not a replacement. The existing better-sqlite3 code continues to work.

User discovered Drizzle Studio and asked about the GraphQL integration advertised there. Had an honest discussion about whether drizzle-graphql made sense for Oracle. Conclusion: no. The core value is FTS5+ChromaDB hybrid search, which GraphQL can't help with. MCP is the primary interface, not HTTP. Adding GraphQL would be complexity without benefit.

Stored that decision in Oracle itself - recursive knowledge capture continues.

---

## What Was Accomplished

### 1. Project Context Feature (from previous)
- `/context` endpoint for ghq-format path detection
- Project column added to all logging tables
- Commit `1e36491`

### 2. Drizzle ORM Setup
- Installed drizzle-orm 0.45.1, drizzle-kit 0.31.8
- Created `drizzle.config.ts` for SQLite
- Used `drizzle-kit pull` to introspect existing DB
- Created clean `src/db/schema.ts` (6 tables)
- Created `src/db/index.ts` (Drizzle client)
- Added db:* npm scripts
- Commit `64708c1`

### 3. Architecture Decision
- Evaluated drizzle-graphql
- Decided to skip (documented reasoning)
- Stored in Oracle knowledge base

---

## Technical Decisions

| Decision | Rationale |
|----------|-----------|
| Use `drizzle-kit pull` | Introspect existing DB rather than rewrite schema |
| Exclude FTS5 tables | Managed by SQLite, not Drizzle |
| Keep existing better-sqlite3 | Non-breaking, tests unchanged |
| Skip GraphQL | Doesn't serve core use case (search, MCP) |

---

## Lessons Learned

1. **drizzle-kit pull** is powerful for existing databases
2. **FTS5 tables** should be excluded from Drizzle schema
3. **Don't add tech because it's available** - add it when it solves a problem
4. **Type exports** in TypeScript need explicit annotation for external library types

---

## Honest Feedback

### What Worked
- drizzle-kit pull auto-generated schema perfectly
- 45 tests passed without modification
- Drizzle Studio provides nice GUI for browsing data
- User engaged in architecture discussion (GraphQL)

### What Could Be Better
- FTS5 tables showed up in Studio despite tablesFilter config
- Could have started frontend sooner (user had to remind me)

### Surprises
- Drizzle Studio is genuinely useful for quick data inspection
- GraphQL discussion was valuable - good to document "no" decisions

---

## Files Changed

```
+850 lines across 6 files

New:
  drizzle.config.ts           (+24)
  src/db/schema.ts            (+96)
  src/db/index.ts             (+42)

Modified:
  package.json                (added db:* scripts)
  pnpm-lock.yaml              (drizzle deps)
```

---

## Commits

| Hash | Description |
|------|-------------|
| 1e36491 | feat: Add project context awareness (ghq format) |
| 64708c1 | feat: Add Drizzle ORM setup with introspected schema |
| d664e42 | chore: clean up ralph loop state |

---

## Services Running

| Service | Port |
|---------|------|
| Oracle HTTP | 37778 |
| React Dashboard | 3001 |
| Drizzle Studio | local.drizzle.studio |

---

## Tags

`drizzle` `migration` `architecture-decision` `graphql` `yagni` `sqlite`
