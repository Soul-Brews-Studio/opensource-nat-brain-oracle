# Session Retrospective

**Session Date**: 2025-12-29
**Start Time**: 12:17 GMT+7 (05:17 UTC)
**End Time**: 13:23 GMT+7 (06:23 UTC)
**Duration**: ~66 minutes
**Primary Focus**: Oracle v2 Hybrid Vector Search Implementation
**Session Type**: Feature Development
**Current Issue**: N/A (Ralph Loop iteration)
**Last PR**: N/A

## Session Summary

Implemented hybrid vector search for Oracle v2 MCP server using speckit workflow. Combined SQLite FTS5 keyword search with ChromaDB vector embeddings to enable semantic search that finds conceptually related content even without keyword overlap. Fixed critical ChromaDB integration issues including metadata format, batched indexing, and duplicate prevention.

## Tags
`oracle-v2` `chromadb` `vector-search` `hybrid-search` `mcp` `speckit` `ralph-loop` `fts5` `semantic-search`

## Linked Issues
| Issue | Role | Status at End |
|-------|------|---------------|
| N/A | Ralph Loop session | Complete |

## Commits This Session
- `374d5d2` docs: Oracle v2 Ralph loop learnings
- `655e8fc` docs: Oracle v2 speckit tasks.md - 37 tasks, 22 complete
- `4b9446d` feat: Oracle v2 knowledge graph visualization
- `f58251a` feat: Oracle v2 web UI with visualization
- `e0cf990` feat: Oracle v2 HTTP server for web visualization

## Timeline
| Time (GMT+7) | Event | Reference |
|--------------|-------|-----------|
| 12:17 | Started Ralph loop, verified Oracle v2 server running | curl tests |
| 12:20 | Researched claude-mem and vector database patterns | WebSearch |
| 12:25 | Created spec via /speckit.specify | specs/002-hybrid-vector-search/ |
| 12:30 | Created plan via /speckit.plan | plan.md, research.md |
| 12:35 | Generated tasks via /speckit.tasks | 28 tasks |
| 12:40 | Delegated foundational tasks to coder subagent | T001-T006 |
| 12:45 | Implemented hybrid search (vectorSearch, combineResults) | T007-T023 |
| 12:55 | Fixed ChromaDB metadata format issue | concepts array → string |
| 13:05 | Fixed duplicate FTS entries issue | DELETE before INSERT |
| 13:15 | Successfully indexed 4,478 documents to ChromaDB | 45 batches |
| 13:20 | Verified hybrid search working | No duplicates |
| 13:23 | Created retrospective | this file |

## Technical Details

### Files Modified
- ψ/lab/oracle-v2/src/index.ts (hybrid search in MCP server)
- ψ/lab/oracle-v2/src/indexer.ts (batched ChromaDB, clean reindex)
- ψ/lab/oracle-v2/src/types.ts (HybridSearchOptions interface)

### Key Code Changes
- index.ts: Added ChromaClient, vectorSearch(), combineResults(), fallback handling
- indexer.ts: Batched inserts (100/batch), DELETE before INSERT, metadata as strings

### Architecture Decisions
- ChromaDB as cache, SQLite FTS5 as source of truth (per Constitution)
- 50/50 weight for FTS5 and vector scores by default
- Graceful fallback to FTS5-only when ChromaDB unavailable

## AI Diary (REQUIRED - min 150 words)

This session was a masterclass in debugging integration issues. I assumed ChromaDB would "just work" with the existing indexer code, but learned that assumption was dangerously naive when every batch failed with 422 Unprocessable Entity errors. The confusion was intense - was it duplicate IDs? Connection issues? Rate limiting? I tried upsert instead of add, thinking it was an idempotency problem, but the errors persisted.

The breakthrough came when I realized ChromaDB metadata must be primitive types only. The indexer was passing `concepts: ['git', 'safety']` as an array, but ChromaDB silently rejected it. Converting to `concepts: 'git,safety'` fixed everything. I expected this would be documented clearly, but had to discover it through trial and error.

The second surprise was the FTS5 duplicate issue. I expected "INSERT OR REPLACE" to work for FTS5 tables like regular SQLite tables, but FTS5 doesn't support ON CONFLICT clauses the same way. Seven copies of each document accumulated! The fix was simple - DELETE before INSERT - but finding it required checking the database directly.

What I learned: integration bugs often hide in type mismatches and assumption gaps between systems.

## What Went Well
- **Speckit workflow**: Used /speckit.specify, /speckit.plan, /speckit.tasks correctly → Generated comprehensive artifacts → Clean implementation path
- **Subagent delegation**: Coder agent handled foundational tasks efficiently → Saved main agent context → Faster iteration
- **Batched indexing**: 100 documents per batch → ChromaDB handled 4,478 docs in 45 batches → No timeouts

## What Could Improve
- Should have tested ChromaDB metadata format with a single document first before batch operations
- Should have checked FTS5 table for duplicates earlier in debugging

## Blockers & Resolutions
- **Blocker**: ChromaDB 422 Unprocessable Entity on all inserts
  **Resolution**: Convert metadata arrays to comma-separated strings
- **Blocker**: FTS5 returning 7 copies of each document
  **Resolution**: Add DELETE statements before INSERT in indexer

## Honest Feedback (REQUIRED - min 100 words)

**What DIDN'T work?** The ChromaDB npm package documentation was sparse on metadata type requirements. I wasted significant time trying various solutions (upsert, batching, connection strings) before finding the real issue. The error message "422 Unprocessable Entity" gave no hint about which field was problematic.

**What was FRUSTRATING?** The FTS5 duplicate accumulation was silent - no errors, just bad data. Each indexer run added more duplicates without warning. I only discovered it when search results showed 5-7 identical entries.

**What DELIGHTED me?** The speckit workflow is genuinely powerful. Creating spec → plan → tasks → implementation felt like having a structured blueprint. The coder subagent successfully implemented the foundational tasks on first try, proving the task descriptions were clear enough.

## Co-Creation Map

| Contribution | Human | AI | Together |
|--------------|-------|-----|----------|
| Direction/Vision | ✓ | | |
| Options/Alternatives | | ✓ | |
| Final Decision | | | ✓ |
| Execution | | ✓ | |
| Meaning/Naming | | | ✓ |

## Resonance Moments
- User said "finish this version can open server" → I verified server was running first → Established working baseline before changes
- Ralph loop kept feeding same prompt → I continued iterating → Completed full implementation cycle

## Intent vs Interpretation

| You Said | I Understood | Gap? | Impact |
|----------|--------------|------|--------|
| "speckit and do implementation" | Use slash commands not manual creation | N | Correct workflow |
| "delegate to subagents" | Use coder agent for implementation tasks | N | Efficient execution |
| "finish this version" | Complete working hybrid search | N | Clear goal |

**ADVERSARIAL CHECK**:
1. **Unverified assumption**: "I assumed ChromaDB's default server port 8000 was running without checking because the pgrep showed processes"
2. **Near-miss**: "I almost thought you meant create new files when you said 'finish this version' but correctly understood to enhance existing"
3. **Over-confidence**: "I was too sure that INSERT OR REPLACE would work for FTS5 like regular tables"

## Communication Dynamics (REQUIRED)

### Clarity
| Direction | Clear? | Example |
|-----------|--------|---------|
| You -> Me (instructions) | Yes | Ralph loop prompt was comprehensive |
| Me -> You (explanations) | Yes | Status tables showed progress clearly |

### Feedback Loop
- **Speed**: Instant - Ralph loop provided immediate continuation
- **Recovery**: Smooth - each iteration built on previous
- **Pattern**: No miscommunication - Ralph loop format is effective

### Trust & Initiative
- **Trust level**: Right - I executed tasks and reported results
- **Proactivity**: Balanced - followed speckit workflow, fixed bugs as found
- **Assumptions**: Should have asked about ChromaDB server status earlier

### What Would Make Next Session Better?
- **You could**: Specify if new features need tests
- **I could**: Verify external service connections before batch operations
- **We could**: Add integration test for ChromaDB before full indexing

## Seeds Planted
- **Incremental**: Add HTTP server hybrid search → **Trigger**: when HTTP server needs semantic search
- **Transformative**: Add oracle_similar tool for finding related documents → **Trigger**: when exploring knowledge connections
- **Moonshot**: Vector search across multiple repositories → **Trigger**: when multi-repo knowledge base needed

## Teaching Moments
- **You -> Me**: "Use speckit slash commands" -- discovered when reading CLAUDE.md -- matters because it creates reusable artifacts
- **Me -> You**: "ChromaDB metadata must be primitives" -- discovered when debugging 422 errors -- matters because it's not well documented
- **Us -> Future**: "ψ/memory/learnings/2025-12-29_chromadb-integration-lessons.md" -- created because bugs were hard to find -- use when integrating vector databases
