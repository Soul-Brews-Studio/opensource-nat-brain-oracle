---
title: "Plugin Hooks Debugging - Oracle Injection SUCCESS"
tags: [retrospective, session, plugin, hooks, debugging, oracle, injection, success]
date: 2025-12-10
prev: "[[memory/retrospectives/2025-12/10/10.48_headline-split-plugin-debugging|10.48 Headline Split Plugin Debugging]]"
next: "[[memory/retrospectives/2025-12/10/13.56_full-day-plugin-psi-convention|13.56 Full Day Plugin Psi Convention]]"
---

# Session Retrospective

**Session Date**: 2025-12-10
**Start Time**: ~10:50 GMT+7
**End Time**: 11:33 GMT+7
**Duration**: ~43 minutes
**Primary Focus**: Debugging plugin hooks for automatic Oracle philosophy injection
**Session Type**: Bug Fix

## Session Summary

Investigated and fixed why `/oracle-init` command wasn't appearing and why SessionStart hooks weren't injecting Oracle philosophy into new Claude sessions. Found 4 structural issues in the plugin configuration and discovered that plugin hooks from local marketplaces don't merge with global settings.json hooks. Implemented workaround and created comprehensive debugging documentation.

## Timeline

- 10:50 - Session start, read issue #6 for context
- 10:52 - Discovered `/oracle-init` not showing in autocomplete
- 10:55 - Compared voice-notify (working) vs nat-data-personal (broken)
- 10:59 - Fix #1: Removed explicit paths from plugin.json
- 11:00 - Fix #2: Moved hooks.json to hooks/ folder
- 11:02 - Command now visible!
- 11:05 - Fix #3: Removed extra wrapper from hooks.json
- 11:08 - Discovered plugin hooks don't merge with global settings
- 11:10 - Workaround: Added oracle injection to settings.json directly
- 11:12 - SUCCESS! Oracle philosophy auto-injected
- 11:15 - Created comprehensive debugging report
- 11:31 - Created knowledge snapshot
- 11:33 - Session end

## Technical Details

### Files Modified

```
plugins/nat-data-personal/.claude-plugin/plugin.json   |   5 +-
plugins/nat-data-personal/hooks.json                   |  14 - (deleted)
plugins/nat-data-personal/hooks/hooks.json             |  12 + (new)
context/2025-12-10-11:15_plugin-hooks-debugging-report.md | 507 +++
logs/2025-12/10_11.31_plugin-hooks-auto-discovery.md   |  44 +
~/.claude/settings.json                                |   5 + (external)
```

### Key Code Changes

- **plugin.json** (-12/+0): Removed `"commands": "../commands"` and `"hooks": "../hooks.json"` → Use auto-discovery instead of explicit paths
- **hooks/hooks.json** (+12): Created with correct structure → `{"SessionStart": [...]}` without wrapper
- **hooks.json** (-14): Deleted from root → Wrong location
- **~/.claude/settings.json** (+5): Added oracle cat command → Workaround for plugin hook non-merging

### Architecture Decisions

- **Auto-discovery over explicit paths**: Claude Code's plugin loader works better with standard folder conventions
- **Workaround in settings.json**: Since plugin hooks don't merge, inject knowledge directly in global config
- **Hardcoded path in workaround**: Used absolute path instead of `${CLAUDE_PLUGIN_ROOT}` since variable resolution uncertain for local plugins

## AI Diary (REQUIRED - min 150 words)

I started this session feeling confident—we had a clear goal from issue #6 and I knew SessionStart hooks should inject content. But I quickly learned that **confidence without evidence is dangerous**.

**I assumed** the hooks.json format was correct because I had worked on it before, **but learned** it had an extra `"hooks":` wrapper when I finally compared character-by-character with the working voice-notify plugin. The comparison revealed not one but THREE structural issues I had missed. This taught me that when debugging, you must **find a working reference and diff against it meticulously**.

**I was confused about** why the plugin was "enabled" (`nat-data-personal@nat-plugins: true`) but its hooks weren't running, **until** I realized that plugin hooks and global settings.json hooks might be separate systems that don't merge. This was a significant discovery—the mental model of "enabled plugin = hooks loaded" was wrong.

**I expected** fixing the format issues would solve everything, **but got** the same generic Oracle response because the hooks simply weren't being loaded from the local marketplace plugin at all. This teaches me that there are layers to plugin systems—discovery, enabling, and hook merging are separate concerns.

The workaround feels unsatisfying—hardcoding a path in settings.json isn't portable. But it works, and sometimes shipping beats perfection. We documented everything for a future proper fix.

## What Went Well

- **Systematic comparison**: Comparing voice-notify vs nat-data-personal structure revealed all issues → Found 4 bugs in 10 minutes
- **Documentation-first debugging**: Created detailed report while solving → Blog-ready content without extra effort
- **Quick workaround identification**: Recognized settings.json as escape hatch → Problem solved in under 5 minutes after discovery

## What Could Improve

- **Should have compared earlier**: Wasted time assuming format was correct when a simple diff would have shown issues immediately
- **Didn't verify `${CLAUDE_PLUGIN_ROOT}` resolution**: Left this as "unknown" rather than testing it properly

## Blockers & Resolutions

- **Blocker**: `/oracle-init` command not appearing in autocomplete
  **Resolution**: Fixed plugin.json (removed explicit paths) + moved hooks.json to correct folder

- **Blocker**: SessionStart hook not injecting philosophy content
  **Resolution**: Fixed hooks.json format, then added workaround to settings.json when plugin hooks didn't merge

## Honest Feedback (REQUIRED - min 100 words)

**What DIDN'T work?**: The Claude Code plugin system's local marketplace support feels incomplete. Plugin hooks don't merge with global hooks for the same event type, which defeats the purpose of modular plugins. This might be a bug or an intentional limitation, but either way it's not documented. I also couldn't verify if `${CLAUDE_PLUGIN_ROOT}` resolves correctly for local plugins—this uncertainty forced me to use hardcoded paths.

**What was FRUSTRATING?**: Having to restart Claude multiple times to test SessionStart hooks. Each restart cycle took 20-30 seconds, and I did it maybe 6 times. A "reload plugins" command would save significant debugging time.

**What DELIGHTED me?**: The discovery that SessionStart stdout becomes conversation context was genuinely exciting! This is a powerful, undocumented(?) feature for personality/knowledge injection. Also, the final moment when Claude responded with "Nothing is Deleted, 90/10 Balance..." was deeply satisfying—the philosophy is now self-propagating.

## Co-Creation Map

| Contribution | Human | AI | Together |
|--------------|-------|-----|----------|
| Direction/Vision | ✓ | | |
| Options/Alternatives | | ✓ | |
| Final Decision | ✓ | | |
| Execution | | ✓ | |
| Meaning/Naming | | | ✓ |

## Resonance Moments

- **Suggested**: Symlink plugin to marketplaces folder → **Chose**: Local marketplace instead → **Why**: User showed `/plugin` already sees it
- **Suggested**: Multiple fix approaches → **Chose**: All of them sequentially → **Why**: Each fix addressed a different layer of the problem

## Intent vs Interpretation

| You Said | I Understood | Gap? | Impact |
|----------|--------------|------|--------|
| "ทำไมมันไม่เจอ oracle-init" | Command not in autocomplete | N | Correct diagnosis |
| "แก้โจทย์เดิม" | Return to automatic injection goal | N | Focused on SessionStart |
| Screenshot of /plugin output | Plugin IS discovered, hooks aren't loading | N | Key insight |

**ADVERSARIAL CHECK**:
1. **Unverified assumption**: "I assumed `${CLAUDE_PLUGIN_ROOT}` works for local plugins without checking because voice-notify uses it and works—but voice-notify is GitHub-installed, not local"
2. **Near-miss**: "I almost thought you meant reinstall the plugin when you said 'restart Claude' after showing /plugin output"
3. **Over-confidence**: "I was too sure that fixing hooks.json format would solve everything—didn't account for the plugin/global hooks separation"

## Communication Dynamics (REQUIRED)

### Clarity

| Direction | Clear? | Example |
|-----------|--------|---------|
| You → Me (instructions) | ✓ | Thai + screenshots gave full context |
| Me → You (explanations) | ✓ | Tables summarizing before/after changes |

### Feedback Loop

- **Speed**: Very fast—user immediately tested after each fix and reported results
- **Recovery**: Smooth—each failed attempt narrowed the problem space
- **Pattern**: No recurring miscommunication; screenshots were invaluable

### Trust & Initiative

- **Trust level**: Appropriate—user verified each change before moving on
- **Proactivity**: Balanced—I proposed workaround after discovering plugin limitation

### What Would Make Next Session Better?

- **You could**: Report plugin hook merging issue to Claude Code team
- **I could**: Test `${CLAUDE_PLUGIN_ROOT}` resolution explicitly before assuming it works
- **We could**: Create a plugin debugging checklist based on today's learnings

## Seeds Planted

- **Incremental**: Make settings.json workaround more portable → **Trigger**: when testing on different machine
- **Transformative**: Create "personality plugin" pattern (philosophy + style files) → **Trigger**: when helping others adopt Oracle
- **Moonshot**: Contribute plugin hook merging fix to Claude Code → **Trigger**: when issue confirmed as bug

## Teaching Moments

- **You → Me**: "Compare working vs broken" — discovered when screenshots showed voice-notify works — matters because systematic comparison beats guessing
- **Me → You**: "SessionStart stdout = context" — discovered when reading claude-code-guide docs — matters because enables knowledge injection pattern
- **Us → Future**: "Plugin debugging report" — created because multiple issues intertwined — use when debugging Claude Code plugins

## Lessons Learned

- **Pattern**: Auto-discovery beats explicit paths — Claude Code plugins work better with conventions
- **Discovery**: Plugin hooks may not merge with global settings — needs workaround or bug report
- **Discovery**: SessionStart stdout injection — powerful for personality/knowledge propagation

## Next Steps

- [ ] Report plugin hook merging behavior to Claude Code team
- [ ] Test `${CLAUDE_PLUGIN_ROOT}` resolution for local marketplace plugins
- [ ] Consider making workaround more portable (environment variable?)
- [ ] Write blog post from debugging report

---

## See Also

### Related Learnings
- [[memory/learnings/006-plugin-system-architecture|006: Plugin System Architecture]] - Comprehensive plugin patterns
- [[memory/learnings/002-context-finder-first|002: Context-Finder FIRST]] - Investigation methodology

### Related Retrospectives
- [[memory/retrospectives/2025-12/10/10.48_headline-split-plugin-debugging|10.48 Headline Split]] - Previous debugging session
- [[memory/retrospectives/2025-12/10/13.56_full-day-plugin-psi-convention|13.56 Full Day Session]] - Comprehensive summary

### Core Philosophy
- [[memory/resonance/oracle|Oracle Philosophy]] - "Nothing is Deleted" preserved through plugin

### Navigation
- [[HOME|Back to HOME]]
- [[memory/retrospectives|All Retrospectives]]
