# Retrospective: Handoff MCP v4 with Bun + Drizzle

**Date**: 2025-12-31 09:15
**Duration**: ~20 minutes
**Context at end**: Continued session

---

## What We Built

Complete rewrite of handoff-mcp using modern stack:

| Component | Technology | Purpose |
|-----------|------------|---------|
| Runtime | Bun | 2-3x faster than Node.js |
| Database | Drizzle ORM + bun:sqlite | Type-safe, native performance |
| Search | FTS5 | Full-text search with ranking |
| Web UI | Bun.serve() | Browse handoffs in browser |
| MCP | @modelcontextprotocol/sdk | AI agent integration |

---

## Speckit Workflow Applied

Successfully followed the full speckit workflow:

1. **/speckit.specify** - Created spec with 4 user stories
2. **/speckit.plan + /debate** - Haiku critic challenged Bun maturity; resolved as learning exercise
3. **/speckit.tasks** - Generated 49 tasks across 7 phases
4. **/speckit.implement** - Implemented all core features

---

## Dev-Browser Test Results

| Test | Endpoint | Result |
|------|----------|--------|
| List view | `http://localhost:3456/` | 21 handoffs |
| Detail view | `/handoff/:filename` | Markdown rendered |
| Search | `/search?q=oracle` | 12 results with excerpts |

Screenshots captured:
- `tmp/handoff-list.png` - Card layout with full paths
- `tmp/handoff-detail.png` - Markdown content rendered
- `tmp/handoff-search.png` - FTS5 search results

---

## Key Technical Decisions

### 1. Bun Over Node.js
- User explicitly requested
- Native SQLite via `bun:sqlite`
- `Bun.serve()` for HTTP (no Express needed)
- Learning exercise in `Ïˆ/lab/`

### 2. Mode Detection via Flag
- Changed from `!process.stdin.isTTY` to `--mcp` flag
- TTY detection unreliable in various contexts
- Cleaner: `bun run src/index.ts` = web, `--mcp` = stdio

### 3. FTS5 Special Character Escaping
- Applied oracle-v2 pattern: `? * + - ( ) ^ ~ " ' :`
- Prevents query errors on user input

---

## Files Created

```
specs/056-handoff-mcp-v4/
â”œâ”€â”€ spec.md, plan.md, tasks.md
â”œâ”€â”€ research.md, data-model.md
â”œâ”€â”€ contracts/schema.ts
â””â”€â”€ checklists/requirements.md

Ïˆ/lab/handoff-mcp-v4/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ db/schema.ts, index.ts, fts.ts
â”‚   â”œâ”€â”€ web/server.ts, routes.ts, templates.ts
â”‚   â”œâ”€â”€ mcp/server.ts
â”‚   â”œâ”€â”€ types.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ package.json, tsconfig.json
â””â”€â”€ CLAUDE.md (Bun-specific instructions)
```

---

## What Went Well

1. **Speckit workflow is smooth** - Structured approach prevents scope creep
2. **Bun is fast** - Server starts instantly, no build step
3. **Dev-browser testing** - Visual confirmation of UI quality
4. **FTS5 works great** - Search returns relevant results with excerpts

---

## What Could Improve

1. **Date parsing** - All dates showing as "Dec 31, 2025" (indexed_at vs actual date)
2. **No pagination** - 21 items is fine, but won't scale
3. **MCP tools untested** - Only tested web UI with dev-browser

---

## Learnings

1. **Bun TTY detection** is unreliable - use explicit flags instead
2. **Drizzle with bun:sqlite** works but needs manual table creation (not auto-migrate)
3. **FTS5 content tables** must have triggers for sync (insert/update/delete)

---

## Commits

```
f5a0a5b feat(056): Handoff MCP v4 with Bun + Drizzle + Web UI
```

---

## Next Steps (if continuing)

- [ ] Test MCP tools with actual Claude integration
- [ ] Fix date display (use frontmatter date, not indexed_at)
- [ ] Add pagination for large handoff collections
- [ ] Create plugin manifest for Claude Code

---

*Happy New Year's Eve! ðŸŽ‰*
