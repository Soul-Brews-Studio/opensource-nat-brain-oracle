# Session Retrospective: Oracle Status Tray (Tauri)

**Date**: 2025-12-30
**Time**: ~08:00 - 09:43 (GMT+7)
**Duration**: ~1.5 hours
**Agent**: 1 (Opus 4.5)

---

## Session Summary

Built a macOS system tray app using Tauri 2.0 to display Oracle MCP server status. The app shows document counts, indexing status, and index health in a popup panel triggered by clicking the tray icon.

---

## Primary Focus

**Oracle Status Tray App Development**

Created a native macOS menu bar app that:
- Shows psi (ψ) icon in system tray
- Displays popup on left-click with Oracle stats
- Shows quit menu on right-click
- Polls HTTP endpoint for real-time status
- Auto-hides popup on focus loss

---

## What Happened

### Completed
1. **Oracle MCP Installation** - Installed oracle-v2, indexed 4,634 documents
2. **Tauri Project Setup** - Created src-tauri structure with Rust backend
3. **System Tray Implementation** - TrayIconBuilder with click handlers
4. **Popup Window** - HTML/CSS dark UI matching macOS aesthetic
5. **HTTP Polling** - ureq client fetching /stats endpoint
6. **Icon Creation** - Converted psi symbol to RGBA PNG for menu bar
7. **LSUIElement** - Made app agent-only (no dock, no menu bar)
8. **Multi-monitor Fix** - Used PhysicalPosition for correct positioning
9. **Debounce** - Added click debounce to prevent double-show

### Blocked/Partial
- Double window issue persists (1 popup + 1 white square)
- Root cause unclear - may be webview rendering issue

---

## AI Diary

This session reminded me why building native apps is both rewarding and frustrating. I started with confidence - Tauri seemed like a clean choice for a simple tray app. But reality hit hard when nothing worked as expected.

The icon issue was my first stumble. Tauri demands RGBA PNG format, and my initial attempts with ImageMagick kept producing the wrong color type. I assumed `convert` would handle it, but the `-define png:color-type=6` flag was essential. I felt foolish not knowing this upfront.

The transparent window saga confused me the most. When the popup showed as a white square, I was certain the HTML wasn't loading. But `strings` on the binary showed the HTML was embedded. The real issue? `transparent: true` in Tauri 2.0 doesn't work the way I expected on macOS. Setting it to `false` fixed the rendering.

The double window problem frustrated me deeply. I added debounce, checked window counts (always shows 1), yet the user kept seeing 2 windows. I suspect the webview might be creating a separate rendering context, but I couldn't prove it. Leaving this unresolved feels like defeat.

The positioning calculation threw me too. I initially used LogicalPosition, assuming Tauri normalized coordinates. Wrong - the tray events return PhysicalPosition on high-DPI displays. On a 5K screen with 2x scaling, my window was appearing 2000 pixels off. Switching to PhysicalPosition fixed it, but only after debugging for too long.

What surprised me most was how much debugging dominated the session. I expected to write code; instead I wrote print statements. The ratio felt off - 20% building, 80% fixing.

---

## Technical Learnings

### Tauri 2.0 System Tray
```rust
// Left click = popup, right click = menu
TrayIconBuilder::new()
    .show_menu_on_left_click(false)
    .on_tray_icon_event(|tray, event| {
        match event {
            TrayIconEvent::Click { button: MouseButton::Left, .. } => {
                // Show popup
            }
            _ => {}
        }
    })
```

### macOS Agent App (No Dock)
```xml
<!-- Info.plist -->
<key>LSUIElement</key>
<true/>
```

### PhysicalPosition for Multi-Monitor
```rust
// Tray events use physical coordinates
let pos = PhysicalPosition::new(
    (x - 280.0) as i32,  // Offset for window width
    (y + 30.0) as i32    // Below menu bar
);
```

### Click Debounce Pattern
```rust
static LAST_CLICK: Mutex<Option<Instant>> = Mutex::new(None);

fn toggle_popup(...) {
    let mut last = LAST_CLICK.lock().unwrap();
    if let Some(t) = *last {
        if t.elapsed() < Duration::from_millis(300) {
            return; // Debounce
        }
    }
    *last = Some(Instant::now());
    // ... toggle logic
}
```

---

## Honest Feedback

### What Went Well
- HTTP polling approach was clean - avoided ZeroMQ/socket complexity
- HTML/CSS popup looked professional (dark theme, proper typography)
- Speckit flow helped structure the initial planning

### Friction Points

1. **Icon Format Hell** - Tauri's RGBA requirement isn't clearly documented. Spent 15+ minutes on ImageMagick flags. Should have checked Tauri examples first.

2. **Transparent Window Confusion** - Setting `transparent: true` broke rendering. Counter-intuitive that transparency causes white backgrounds. Wasted time assuming HTML wasn't loading.

3. **Double Window Mystery** - Still unresolved. Debug logs show 1 window, user sees 2. This suggests either a framework bug or misunderstanding of Tauri's webview model. Need to file issue or read source.

### What I'd Do Differently
- Start with Tauri's official tray example, not from scratch
- Test on single monitor first before multi-monitor debugging
- Add version display to window (not just console) for faster iteration

---

## Communication Dynamics

| Aspect | Rating | Notes |
|--------|--------|-------|
| Clarity | 3/5 | User feedback was brief ("it show 2", "can not click") - needed screenshots |
| Response time | 4/5 | Quick iterations but too many version bumps |
| Understanding | 3/5 | Took multiple attempts to understand double window issue |
| Collaboration | 4/5 | User provided helpful screenshots, psi icon URL |

---

## Co-Creation Map

| Action | Human | AI |
|--------|-------|-----|
| Idea | ● | ○ | Human wanted tray app for Oracle status |
| Research | ○ | ● | AI explored Tauri APIs, tray patterns |
| Implementation | ○ | ● | AI wrote all Rust/HTML code |
| Testing | ● | ○ | Human tested each build, reported issues |
| Debugging | ○ | ● | AI added debug logs, tried fixes |

---

## Intent vs Interpretation

| Human Intent | AI Interpretation | Gap |
|--------------|-------------------|-----|
| "Simple tray app" | Full-featured popup with stats | None - matched well |
| "Use this image" (psi) | Convert to RGBA, use as tray icon | None - understood |
| "why it show 2" | Debug window creation | Medium - couldn't fully resolve |
| "can not click" | App unresponsive, need kill | Small - fixed quickly |

---

## Files Changed

### Created
- `ψ/lab/oracle-status-tray/` - Full Tauri project
  - `src-tauri/src/lib.rs` - Rust tray logic
  - `src-tauri/Cargo.toml` - Dependencies
  - `src-tauri/tauri.conf.json` - Window/tray config
  - `src-tauri/Info.plist` - LSUIElement
  - `src/index.html` - Popup UI
- `specs/048-oracle-status-tray/spec.md` - Feature specification

### Modified
- `ψ/lab/oracle-v2/src/indexer.ts` - Added indexing status table
- `ψ/lab/oracle-v2/src/server.ts` - Added indexing status to /stats
- `.gitignore` - Added Rust target/, *.dmg, *.app

---

## Open Questions

1. Why does user see 2 windows when code shows only 1?
2. Is this a Tauri/wry bug with transparent webviews?
3. Should we use SwiftUI instead for native macOS feel?

---

## Next Steps

- [ ] Debug double window issue (check Tauri GitHub issues)
- [ ] Test on fresh macOS user account
- [ ] Consider bundling as standalone .app for distribution
- [ ] Add actual re-index functionality (call server endpoint)

---

## Validation Checklist

- [x] AI Diary: 150+ words with vulnerability (assumption/confusion)
- [x] Honest Feedback: 100+ words with 3 friction points
- [x] Communication Dynamics: Table filled
- [x] Co-Creation Map: All 5 rows marked
- [x] Intent vs Interpretation: Gap analysis done
- [x] Technical learnings documented

---

*Generated: 2025-12-30 09:43 GMT+7*
