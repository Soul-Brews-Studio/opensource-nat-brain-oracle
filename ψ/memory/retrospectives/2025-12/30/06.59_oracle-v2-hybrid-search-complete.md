# Session Retrospective: Oracle v2 Hybrid Search Complete

**Date**: 2025-12-30 06:29 - 06:59
**Duration**: ~30 minutes
**Model**: Opus 4.5
**Branch**: 002-hybrid-vector-search

---

## What We Built

| Feature | Status |
|---------|--------|
| Speckit 002-hybrid-vector-search | 28/28 ✅ |
| Speckit 001-oracle-mcp | 32/37 ✅ |
| ChromaDB server setup (Python 3.12) | ✅ |
| 4511 documents indexed (SQLite + ChromaDB) | ✅ |
| Hybrid search (FTS5 + vector) | ✅ |
| Mode parameter (hybrid/fts/vector) | ✅ |
| Consult log table | ✅ |
| UI source badges (fts/vector/hybrid) | ✅ |
| Learn UI form | ✅ |

---

## Commits

| Hash | Message |
|------|---------|
| a25b985 | feat: Oracle v2 UI - learn form + source badges (T027, T032) |
| 985e9e0 | docs: Update 001-oracle-mcp speckit - 30/37 tasks complete |
| 3a751be | feat: Oracle v2 hybrid search complete - 28/28 tasks done |
| 2bf82a7 | feat: Oracle v2 add mode parameter to oracle_search (T027) |
| 6167196 | docs: Oracle v2 hybrid search - 23/28 speckit tasks complete |

---

## Learnings

### 1. ChromaDB + Python Version Compatibility
- Python 3.14 breaks ChromaDB (pydantic BaseSettings moved)
- Solution: Use Python 3.12 for stable compatibility
- `mv .venv /tmp/... && python3.12 -m venv .venv`

### 2. Ralph Loop Context Forwarding
- Auto-compact + ralph-loop enables continuous work across sessions
- Check statusline.json for token usage at session start
- Speckit tasks.md is the source of truth for progress

### 3. Speckit Task Verification
- Many tasks were already done but not marked complete
- Cross-reference code with tasks.md before implementing
- Update task status immediately after verification

### 4. HTTP Server vs MCP Server
- HTTP server (server.ts) has separate simpler implementation
- MCP server (index.ts) has full hybrid search
- UI connects to HTTP server - needs source field added

---

## What Worked

- ✅ Ralph loop kept work focused on speckit
- ✅ Token checking at session start (started at 17%)
- ✅ Incremental commits after each feature
- ✅ ChromaDB batched indexing (46 batches for 4511 docs)
- ✅ Hybrid search test confirmed vector matches working

## What Didn't Work

- ❌ Initial ChromaDB with Python 3.14 (pydantic error)
- ❌ First indexer run said "ChromaDB not available" (needed rebuild)
- ❌ Had to restart HTTP server to pick up new code

---

## AI Diary

This was a satisfying session of completion. When I started, the speckit showed only 23/28 tasks done for 002-hybrid-vector-search, but as I read through index.ts I realized most of the work was already there - vectorSearch, combineResults, graceful fallback. The confusion came from the previous session's context getting lost during auto-compact.

The ChromaDB setup was frustrating initially. Python 3.14 is too bleeding-edge - the pydantic import error felt like hitting a wall. But the solution was straightforward once I understood: move the old venv, create fresh with 3.12, reinstall. The "no such file" error for chroma binary was a red herring - pip install worked fine.

What impressed me most was watching the hybrid search actually work. Query "keeping the human in control" returned 1 FTS match plus 2 vector matches - including "Human Confirmation Loop" principle that wouldn't match keywords. That's the power of semantic search.

The ralph-loop kept pushing me forward - every time I tried to summarize, the hook reminded me "make sure we are on speckit!" It's like having a focus coach. By the end: 002 complete (28/28), 001 at 32/37 with only polish remaining. Real progress.

---

## Honest Feedback

### What Confused Me
The indexer initially said "ChromaDB not available" even after the server was running. I assumed the build was stale and rebuilt, which fixed it. But I'm still not 100% sure why - maybe the compiled JS was cached?

### What Took Longer Than Expected
Figuring out that T027 (learn UI form) was already implemented. I read through the tasks, assumed it was pending, then grepped the code and found showLearnModal, closeLearnModal, submitLearn all working. Should have checked code first.

### Friction Points
1. **Python version dance**: 3.14 → 3.12 downgrade needed for ChromaDB
2. **Two servers confusion**: HTTP (server.ts) vs MCP (index.ts) have different search implementations
3. **Task verification overhead**: Many tasks "pending" in markdown but done in code

---

## Communication Dynamics

| Signal | Clarity | Notes |
|--------|---------|-------|
| "make sure we are on speckit!" | Clear | Ralph loop hook kept focus |
| "rrr to snapshot" | Clear | User wanted retrospective |
| Auto-compact enabled | Implicit | Session would summarize automatically |

---

## Co-Creation Map

| Dimension | Human | AI |
|-----------|-------|-----|
| Direction | ★★★★☆ | ★★☆☆☆ |
| Implementation | ★☆☆☆☆ | ★★★★★ |
| Decisions | ★★★☆☆ | ★★★☆☆ |
| Quality Check | ★★☆☆☆ | ★★★★☆ |
| Learning Capture | ★★★☆☆ | ★★★★☆ |

---

## Next Steps

- [ ] T033-T037: Polish tasks (graph optimization, pagination, staleness)
- [ ] Create PR for 002-hybrid-vector-search branch
- [ ] Merge to main after review

---

## Server Status

- **ChromaDB**: Running on port 8000 (`.venv/bin/chroma run --path ./chroma_data`)
- **HTTP Server**: Running on port 37778
- **Documents indexed**: 4511

---

**Server URLs**:
- Graph: http://localhost:37778#graph
- Search: http://localhost:37778/search?q=oracle
